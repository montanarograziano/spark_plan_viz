<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Spark Physical Plan</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            background: #f4f6f8;
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        #header {
            padding: 10px 20px;
            border-bottom: 1px solid #ddd;
            background: #fff;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
            z-index: 10;
        }

        h2 {
            margin: 0;
            color: #333;
            font-size: 18px;
        }

        .legend {
            font-size: 12px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        #main-container {
            display: flex;
            flex: 1;
            overflow: hidden;
            position: relative;
        }

        #tree-container {
            flex: 1;
            height: 100%;
            background: white;
            overflow: hidden;
            cursor: grab;
        }

        #tree-container:active {
            cursor: grabbing;
        }

        /* Details Panel (replaces Tooltip) */
        #details-panel {
            width: 400px;
            background: #fff;
            border-left: 1px solid #ddd;
            padding: 20px;
            overflow-y: auto;
            display: none;
            /* Hidden by default */
            flex-shrink: 0;
            box-shadow: -2px 0 5px rgba(0, 0, 0, 0.05);
            position: relative;
            z-index: 20;
        }

        #details-panel.visible {
            display: block;
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 15px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }

        .panel-header h3 {
            margin: 0;
            color: #2c3e50;
            font-size: 16px;
        }

        .close-btn {
            cursor: pointer;
            color: #999;
            font-size: 20px;
            line-height: 1;
            border: none;
            background: none;
        }

        .close-btn:hover {
            color: #333;
        }

        .details-section {
            margin-bottom: 15px;
        }

        .details-label {
            color: #7f8c8d;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .details-content {
            font-family: "Consolas", "Monaco", monospace;
            font-size: 12px;
            color: #34495e;
            white-space: pre-wrap;
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #eee;
        }

        /* Node Styling */
        .node circle {
            fill: #fff;
            stroke: steelblue;
            stroke-width: 2px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .node circle:hover {
            stroke-width: 3px;
        }

        .node.selected circle {
            stroke: #333 !important;
            stroke-width: 3px;
        }

        .node text {
            font: 12px sans-serif;
            pointer-events: none;
            text-shadow: 0 1px 0 #fff, 1px 0 0 #fff, 0 -1px 0 #fff, -1px 0 0 #fff;
        }

        .link {
            fill: none;
            stroke: #ccc;
            stroke-width: 1.5px;
            opacity: 0.6;
        }

        /* Node Type Colors */
        .node.shuffle circle {
            stroke: #e74c3c;
            fill: #fadbd8;
        }

        .node.scan circle {
            stroke: #27ae60;
            fill: #d5f5e3;
        }

        .node.join circle {
            stroke: #8e44ad;
            fill: #ebdef0;
        }

        .node.filter circle {
            stroke: #f39c12;
            fill: #fdebd0;
        }

        .node.aggregate circle {
            stroke: #2980b9;
            fill: #d6eaf8;
        }

        .node.sort circle {
            stroke: #d35400;
            fill: #edbb99;
        }

        .node.project circle {
            stroke: #7f8c8d;
            fill: #eaeded;
        }

        .node.window circle {
            stroke: #16a085;
            fill: #a2d9ce;
        }

        .node.union circle {
            stroke: #2c3e50;
            fill: #abb2b9;
        }

        /* Controls */
        .controls {
            position: absolute;
            bottom: 20px;
            left: 20px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            z-index: 5;
        }

        .btn {
            background: white;
            border: 1px solid #ccc;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .btn:hover {
            background: #f0f0f0;
        }
    </style>
</head>

<body>

    <div id="header">
        <h2>Spark Physical Plan</h2>
        <div class="legend">
            <div class="legend-item">
                <div class="dot" style="background: #e74c3c"></div> Exchange
            </div>
            <div class="legend-item">
                <div class="dot" style="background: #8e44ad"></div> Join
            </div>
            <div class="legend-item">
                <div class="dot" style="background: #27ae60"></div> Scan
            </div>
            <div class="legend-item">
                <div class="dot" style="background: #f39c12"></div> Filter
            </div>
            <div class="legend-item">
                <div class="dot" style="background: #2980b9"></div> Agg
            </div>
            <div class="legend-item">
                <div class="dot" style="background: #d35400"></div> Sort
            </div>
            <div class="legend-item">
                <div class="dot" style="background: #16a085"></div> Window
            </div>
            <div class="legend-item">
                <div class="dot" style="background: #7f8c8d"></div> Project
            </div>
        </div>
    </div>

    <div id="main-container">
        <div id="tree-container"></div>
        <div id="details-panel">
            <div class="panel-header">
                <h3 id="panel-title">Node Details</h3>
                <button class="close-btn" onclick="closePanel()">×</button>
            </div>
            <div id="panel-content"></div>
        </div>

        <div class="controls">
            <button class="btn" onclick="zoomIn()" title="Zoom In">+</button>
            <button class="btn" onclick="zoomOut()" title="Zoom Out">-</button>
            <button class="btn" onclick="resetZoom()" title="Reset View">⟲</button>
        </div>
    </div>

    <!-- Load D3.js from CDN -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script>
        const treeData = {"name": "AdaptiveSparkPlan", "description": "AdaptiveSparkPlan isFinalPlan=false\n+- Project [Name#0, Department#6]\n   +- Sort [Salary#10L DESC NULLS LAST], true, 0\n      +- Exchange rangepartitioning(Salary#10L DESC NULLS LAST, 200), ENSURE_REQUIREMENTS, [plan_id=66]\n         +- Project [Name#0, Department#6, Salary#10L]\n            +- SortMergeJoin [Name#0], [Name#9], Inner\n               :- Project [Name#0, Department#6]\n               :  +- SortMergeJoin [Name#0], [Name#5], Inner\n               :     :- Sort [Name#0 ASC NULLS FIRST], false, 0\n               :     :  +- Exchange hashpartitioning(Name#0, 200), ENSURE_REQUIREMENTS, [plan_id=53]\n               :     :     +- Project [Name#0]\n               :     :        +- Filter ((isnotnull(Age#1L) AND (Age#1L > 25)) AND isnotnull(Name#0))\n               :     :           +- Scan ExistingRDD[Name#0,Age#1L]\n               :     +- Sort [Name#5 ASC NULLS FIRST], false, 0\n               :        +- Exchange hashpartitioning(Name#5, 200), ENSURE_REQUIREMENTS, [plan_id=54]\n               :           +- Filter isnotnull(Name#5)\n               :              +- Scan ExistingRDD[Name#5,Department#6]\n               +- Sort [Name#9 ASC NULLS FIRST], false, 0\n                  +- Exchange hashpartitioning(Name#9, 200), ENSURE_REQUIREMENTS, [plan_id=61]\n                     +- Filter ((isnotnull(Salary#10L) AND (Salary#10L > 60000)) AND isnotnull(Name#9))\n                        +- Scan ExistingRDD[Name#9,Salary#10L]\n", "output": ["Name#0", "Department#6"], "type": "other", "children": [{"name": "Project", "description": "Project [Name#0, Department#6]\n+- Sort [Salary#10L DESC NULLS LAST], true, 0\n   +- Exchange rangepartitioning(Salary#10L DESC NULLS LAST, 200), ENSURE_REQUIREMENTS, [plan_id=66]\n      +- Project [Name#0, Department#6, Salary#10L]\n         +- SortMergeJoin [Name#0], [Name#9], Inner\n            :- Project [Name#0, Department#6]\n            :  +- SortMergeJoin [Name#0], [Name#5], Inner\n            :     :- Sort [Name#0 ASC NULLS FIRST], false, 0\n            :     :  +- Exchange hashpartitioning(Name#0, 200), ENSURE_REQUIREMENTS, [plan_id=53]\n            :     :     +- Project [Name#0]\n            :     :        +- Filter ((isnotnull(Age#1L) AND (Age#1L > 25)) AND isnotnull(Name#0))\n            :     :           +- Scan ExistingRDD[Name#0,Age#1L]\n            :     +- Sort [Name#5 ASC NULLS FIRST], false, 0\n            :        +- Exchange hashpartitioning(Name#5, 200), ENSURE_REQUIREMENTS, [plan_id=54]\n            :           +- Filter isnotnull(Name#5)\n            :              +- Scan ExistingRDD[Name#5,Department#6]\n            +- Sort [Name#9 ASC NULLS FIRST], false, 0\n               +- Exchange hashpartitioning(Name#9, 200), ENSURE_REQUIREMENTS, [plan_id=61]\n                  +- Filter ((isnotnull(Salary#10L) AND (Salary#10L > 60000)) AND isnotnull(Name#9))\n                     +- Scan ExistingRDD[Name#9,Salary#10L]\n", "output": ["Name#0", "Department#6"], "type": "project", "children": [{"name": "Sort", "description": "Sort [Salary#10L DESC NULLS LAST], true, 0\n+- Exchange rangepartitioning(Salary#10L DESC NULLS LAST, 200), ENSURE_REQUIREMENTS, [plan_id=66]\n   +- Project [Name#0, Department#6, Salary#10L]\n      +- SortMergeJoin [Name#0], [Name#9], Inner\n         :- Project [Name#0, Department#6]\n         :  +- SortMergeJoin [Name#0], [Name#5], Inner\n         :     :- Sort [Name#0 ASC NULLS FIRST], false, 0\n         :     :  +- Exchange hashpartitioning(Name#0, 200), ENSURE_REQUIREMENTS, [plan_id=53]\n         :     :     +- Project [Name#0]\n         :     :        +- Filter ((isnotnull(Age#1L) AND (Age#1L > 25)) AND isnotnull(Name#0))\n         :     :           +- Scan ExistingRDD[Name#0,Age#1L]\n         :     +- Sort [Name#5 ASC NULLS FIRST], false, 0\n         :        +- Exchange hashpartitioning(Name#5, 200), ENSURE_REQUIREMENTS, [plan_id=54]\n         :           +- Filter isnotnull(Name#5)\n         :              +- Scan ExistingRDD[Name#5,Department#6]\n         +- Sort [Name#9 ASC NULLS FIRST], false, 0\n            +- Exchange hashpartitioning(Name#9, 200), ENSURE_REQUIREMENTS, [plan_id=61]\n               +- Filter ((isnotnull(Salary#10L) AND (Salary#10L > 60000)) AND isnotnull(Name#9))\n                  +- Scan ExistingRDD[Name#9,Salary#10L]\n", "output": ["Name#0", "Department#6", "Salary#10L"], "type": "sort", "children": [{"name": "Exchange", "description": "Exchange rangepartitioning(Salary#10L DESC NULLS LAST, 200), ENSURE_REQUIREMENTS, [plan_id=66]\n+- Project [Name#0, Department#6, Salary#10L]\n   +- SortMergeJoin [Name#0], [Name#9], Inner\n      :- Project [Name#0, Department#6]\n      :  +- SortMergeJoin [Name#0], [Name#5], Inner\n      :     :- Sort [Name#0 ASC NULLS FIRST], false, 0\n      :     :  +- Exchange hashpartitioning(Name#0, 200), ENSURE_REQUIREMENTS, [plan_id=53]\n      :     :     +- Project [Name#0]\n      :     :        +- Filter ((isnotnull(Age#1L) AND (Age#1L > 25)) AND isnotnull(Name#0))\n      :     :           +- Scan ExistingRDD[Name#0,Age#1L]\n      :     +- Sort [Name#5 ASC NULLS FIRST], false, 0\n      :        +- Exchange hashpartitioning(Name#5, 200), ENSURE_REQUIREMENTS, [plan_id=54]\n      :           +- Filter isnotnull(Name#5)\n      :              +- Scan ExistingRDD[Name#5,Department#6]\n      +- Sort [Name#9 ASC NULLS FIRST], false, 0\n         +- Exchange hashpartitioning(Name#9, 200), ENSURE_REQUIREMENTS, [plan_id=61]\n            +- Filter ((isnotnull(Salary#10L) AND (Salary#10L > 60000)) AND isnotnull(Name#9))\n               +- Scan ExistingRDD[Name#9,Salary#10L]\n", "output": ["Name#0", "Department#6", "Salary#10L"], "type": "shuffle", "children": [{"name": "Project", "description": "Project [Name#0, Department#6, Salary#10L]\n+- SortMergeJoin [Name#0], [Name#9], Inner\n   :- Project [Name#0, Department#6]\n   :  +- SortMergeJoin [Name#0], [Name#5], Inner\n   :     :- Sort [Name#0 ASC NULLS FIRST], false, 0\n   :     :  +- Exchange hashpartitioning(Name#0, 200), ENSURE_REQUIREMENTS, [plan_id=53]\n   :     :     +- Project [Name#0]\n   :     :        +- Filter ((isnotnull(Age#1L) AND (Age#1L > 25)) AND isnotnull(Name#0))\n   :     :           +- Scan ExistingRDD[Name#0,Age#1L]\n   :     +- Sort [Name#5 ASC NULLS FIRST], false, 0\n   :        +- Exchange hashpartitioning(Name#5, 200), ENSURE_REQUIREMENTS, [plan_id=54]\n   :           +- Filter isnotnull(Name#5)\n   :              +- Scan ExistingRDD[Name#5,Department#6]\n   +- Sort [Name#9 ASC NULLS FIRST], false, 0\n      +- Exchange hashpartitioning(Name#9, 200), ENSURE_REQUIREMENTS, [plan_id=61]\n         +- Filter ((isnotnull(Salary#10L) AND (Salary#10L > 60000)) AND isnotnull(Name#9))\n            +- Scan ExistingRDD[Name#9,Salary#10L]\n", "output": ["Name#0", "Department#6", "Salary#10L"], "type": "project", "children": [{"name": "SortMergeJoin", "description": "SortMergeJoin [Name#0], [Name#9], Inner\n:- Project [Name#0, Department#6]\n:  +- SortMergeJoin [Name#0], [Name#5], Inner\n:     :- Sort [Name#0 ASC NULLS FIRST], false, 0\n:     :  +- Exchange hashpartitioning(Name#0, 200), ENSURE_REQUIREMENTS, [plan_id=53]\n:     :     +- Project [Name#0]\n:     :        +- Filter ((isnotnull(Age#1L) AND (Age#1L > 25)) AND isnotnull(Name#0))\n:     :           +- Scan ExistingRDD[Name#0,Age#1L]\n:     +- Sort [Name#5 ASC NULLS FIRST], false, 0\n:        +- Exchange hashpartitioning(Name#5, 200), ENSURE_REQUIREMENTS, [plan_id=54]\n:           +- Filter isnotnull(Name#5)\n:              +- Scan ExistingRDD[Name#5,Department#6]\n+- Sort [Name#9 ASC NULLS FIRST], false, 0\n   +- Exchange hashpartitioning(Name#9, 200), ENSURE_REQUIREMENTS, [plan_id=61]\n      +- Filter ((isnotnull(Salary#10L) AND (Salary#10L > 60000)) AND isnotnull(Name#9))\n         +- Scan ExistingRDD[Name#9,Salary#10L]\n", "output": ["Name#0", "Department#6", "Name#9", "Salary#10L"], "type": "join", "children": [{"name": "Project", "description": "Project [Name#0, Department#6]\n+- SortMergeJoin [Name#0], [Name#5], Inner\n   :- Sort [Name#0 ASC NULLS FIRST], false, 0\n   :  +- Exchange hashpartitioning(Name#0, 200), ENSURE_REQUIREMENTS, [plan_id=53]\n   :     +- Project [Name#0]\n   :        +- Filter ((isnotnull(Age#1L) AND (Age#1L > 25)) AND isnotnull(Name#0))\n   :           +- Scan ExistingRDD[Name#0,Age#1L]\n   +- Sort [Name#5 ASC NULLS FIRST], false, 0\n      +- Exchange hashpartitioning(Name#5, 200), ENSURE_REQUIREMENTS, [plan_id=54]\n         +- Filter isnotnull(Name#5)\n            +- Scan ExistingRDD[Name#5,Department#6]\n", "output": ["Name#0", "Department#6"], "type": "project", "children": [{"name": "SortMergeJoin", "description": "SortMergeJoin [Name#0], [Name#5], Inner\n:- Sort [Name#0 ASC NULLS FIRST], false, 0\n:  +- Exchange hashpartitioning(Name#0, 200), ENSURE_REQUIREMENTS, [plan_id=53]\n:     +- Project [Name#0]\n:        +- Filter ((isnotnull(Age#1L) AND (Age#1L > 25)) AND isnotnull(Name#0))\n:           +- Scan ExistingRDD[Name#0,Age#1L]\n+- Sort [Name#5 ASC NULLS FIRST], false, 0\n   +- Exchange hashpartitioning(Name#5, 200), ENSURE_REQUIREMENTS, [plan_id=54]\n      +- Filter isnotnull(Name#5)\n         +- Scan ExistingRDD[Name#5,Department#6]\n", "output": ["Name#0", "Name#5", "Department#6"], "type": "join", "children": [{"name": "Sort", "description": "Sort [Name#0 ASC NULLS FIRST], false, 0\n+- Exchange hashpartitioning(Name#0, 200), ENSURE_REQUIREMENTS, [plan_id=53]\n   +- Project [Name#0]\n      +- Filter ((isnotnull(Age#1L) AND (Age#1L > 25)) AND isnotnull(Name#0))\n         +- Scan ExistingRDD[Name#0,Age#1L]\n", "output": ["Name#0"], "type": "sort", "children": [{"name": "Exchange", "description": "Exchange hashpartitioning(Name#0, 200), ENSURE_REQUIREMENTS, [plan_id=53]\n+- Project [Name#0]\n   +- Filter ((isnotnull(Age#1L) AND (Age#1L > 25)) AND isnotnull(Name#0))\n      +- Scan ExistingRDD[Name#0,Age#1L]\n", "output": ["Name#0"], "type": "shuffle", "children": [{"name": "Project", "description": "Project [Name#0]\n+- Filter ((isnotnull(Age#1L) AND (Age#1L > 25)) AND isnotnull(Name#0))\n   +- Scan ExistingRDD[Name#0,Age#1L]\n", "output": ["Name#0"], "type": "project", "children": [{"name": "Filter", "description": "Filter ((isnotnull(Age#1L) AND (Age#1L > 25)) AND isnotnull(Name#0))\n+- Scan ExistingRDD[Name#0,Age#1L]\n", "output": ["Name#0", "Age#1L"], "type": "filter", "children": [{"name": "Scan ExistingRDD", "description": "Scan ExistingRDD[Name#0,Age#1L]\n", "output": ["Name#0", "Age#1L"], "type": "scan", "children": [], "metrics": {"numOutputRows": 0}}], "metrics": {"numOutputRows": 0}}], "metrics": {}}], "metrics": {"shuffleRecordsWritten": 0, "remoteMergedReqsDuration": 0, "remoteMergedBlocksFetched": 0, "recordsRead": 0, "localBytesRead": 0, "mergedFetchFallbackCount": 0, "localBlocksFetched": 0, "remoteMergedChunksFetched": 0, "remoteBlocksFetched": 0, "dataSize": 0, "localMergedBytesRead": 0, "localMergedChunksFetched": 0, "shuffleWriteTime": 0, "remoteMergedBytesRead": 0, "localMergedBlocksFetched": 0, "corruptMergedBlockChunks": 0, "fetchWaitTime": 0, "remoteBytesRead": 0, "numPartitions": 0, "remoteReqsDuration": 0, "remoteBytesReadToDisk": 0, "shuffleBytesWritten": 0}}], "metrics": {"sortTime": 0, "peakMemory": 0, "spillSize": 0}}, {"name": "Sort", "description": "Sort [Name#5 ASC NULLS FIRST], false, 0\n+- Exchange hashpartitioning(Name#5, 200), ENSURE_REQUIREMENTS, [plan_id=54]\n   +- Filter isnotnull(Name#5)\n      +- Scan ExistingRDD[Name#5,Department#6]\n", "output": ["Name#5", "Department#6"], "type": "sort", "children": [{"name": "Exchange", "description": "Exchange hashpartitioning(Name#5, 200), ENSURE_REQUIREMENTS, [plan_id=54]\n+- Filter isnotnull(Name#5)\n   +- Scan ExistingRDD[Name#5,Department#6]\n", "output": ["Name#5", "Department#6"], "type": "shuffle", "children": [{"name": "Filter", "description": "Filter isnotnull(Name#5)\n+- Scan ExistingRDD[Name#5,Department#6]\n", "output": ["Name#5", "Department#6"], "type": "filter", "children": [{"name": "Scan ExistingRDD", "description": "Scan ExistingRDD[Name#5,Department#6]\n", "output": ["Name#5", "Department#6"], "type": "scan", "children": [], "metrics": {"numOutputRows": 0}}], "metrics": {"numOutputRows": 0}}], "metrics": {"shuffleRecordsWritten": 0, "remoteMergedReqsDuration": 0, "remoteMergedBlocksFetched": 0, "recordsRead": 0, "localBytesRead": 0, "mergedFetchFallbackCount": 0, "localBlocksFetched": 0, "remoteMergedChunksFetched": 0, "remoteBlocksFetched": 0, "dataSize": 0, "localMergedBytesRead": 0, "localMergedChunksFetched": 0, "shuffleWriteTime": 0, "remoteMergedBytesRead": 0, "localMergedBlocksFetched": 0, "corruptMergedBlockChunks": 0, "fetchWaitTime": 0, "remoteBytesRead": 0, "numPartitions": 0, "remoteReqsDuration": 0, "remoteBytesReadToDisk": 0, "shuffleBytesWritten": 0}}], "metrics": {"sortTime": 0, "peakMemory": 0, "spillSize": 0}}], "metrics": {"numOutputRows": 0, "spillSize": 0}}], "metrics": {}}, {"name": "Sort", "description": "Sort [Name#9 ASC NULLS FIRST], false, 0\n+- Exchange hashpartitioning(Name#9, 200), ENSURE_REQUIREMENTS, [plan_id=61]\n   +- Filter ((isnotnull(Salary#10L) AND (Salary#10L > 60000)) AND isnotnull(Name#9))\n      +- Scan ExistingRDD[Name#9,Salary#10L]\n", "output": ["Name#9", "Salary#10L"], "type": "sort", "children": [{"name": "Exchange", "description": "Exchange hashpartitioning(Name#9, 200), ENSURE_REQUIREMENTS, [plan_id=61]\n+- Filter ((isnotnull(Salary#10L) AND (Salary#10L > 60000)) AND isnotnull(Name#9))\n   +- Scan ExistingRDD[Name#9,Salary#10L]\n", "output": ["Name#9", "Salary#10L"], "type": "shuffle", "children": [{"name": "Filter", "description": "Filter ((isnotnull(Salary#10L) AND (Salary#10L > 60000)) AND isnotnull(Name#9))\n+- Scan ExistingRDD[Name#9,Salary#10L]\n", "output": ["Name#9", "Salary#10L"], "type": "filter", "children": [{"name": "Scan ExistingRDD", "description": "Scan ExistingRDD[Name#9,Salary#10L]\n", "output": ["Name#9", "Salary#10L"], "type": "scan", "children": [], "metrics": {"numOutputRows": 0}}], "metrics": {"numOutputRows": 0}}], "metrics": {"shuffleRecordsWritten": 0, "remoteMergedReqsDuration": 0, "remoteMergedBlocksFetched": 0, "recordsRead": 0, "localBytesRead": 0, "mergedFetchFallbackCount": 0, "localBlocksFetched": 0, "remoteMergedChunksFetched": 0, "remoteBlocksFetched": 0, "dataSize": 0, "localMergedBytesRead": 0, "localMergedChunksFetched": 0, "shuffleWriteTime": 0, "remoteMergedBytesRead": 0, "localMergedBlocksFetched": 0, "corruptMergedBlockChunks": 0, "fetchWaitTime": 0, "remoteBytesRead": 0, "numPartitions": 0, "remoteReqsDuration": 0, "remoteBytesReadToDisk": 0, "shuffleBytesWritten": 0}}], "metrics": {"sortTime": 0, "peakMemory": 0, "spillSize": 0}}], "metrics": {"numOutputRows": 0, "spillSize": 0}}], "metrics": {}}], "metrics": {"shuffleRecordsWritten": 0, "remoteMergedReqsDuration": 0, "remoteMergedBlocksFetched": 0, "recordsRead": 0, "localBytesRead": 0, "mergedFetchFallbackCount": 0, "localBlocksFetched": 0, "remoteMergedChunksFetched": 0, "remoteBlocksFetched": 0, "dataSize": 0, "localMergedBytesRead": 0, "localMergedChunksFetched": 0, "shuffleWriteTime": 0, "remoteMergedBytesRead": 0, "localMergedBlocksFetched": 0, "corruptMergedBlockChunks": 0, "fetchWaitTime": 0, "remoteBytesRead": 0, "numPartitions": 0, "remoteReqsDuration": 0, "remoteBytesReadToDisk": 0, "shuffleBytesWritten": 0}}], "metrics": {"sortTime": 0, "peakMemory": 0, "spillSize": 0}}], "metrics": {}}], "metrics": {}};

        // Set dimensions
        const container = document.getElementById('tree-container');
        let width = container.clientWidth;
        let height = container.clientHeight;

        // Vertical Layout: Swap x and y concepts in d3
        // We want the tree to grow Downwards.
        // X axis = width (siblings)
        // Y axis = height (depth)

        const svg = d3.select("#tree-container").append("svg")
            .attr("width", "100%")
            .attr("height", "100%")
            .call(d3.zoom().on("zoom", function (event) {
                g.attr("transform", event.transform);
            }))
            .append("g")
            .attr("transform", "translate(" + width / 2 + "," + 50 + ")");

        const g = svg.append("g");
        let i = 0, duration = 500, root;

        // Node Size: [Width, Height] spacing
        const treemap = d3.tree().nodeSize([120, 100]);

        // Assigns parent, children, height, depth
        root = d3.hierarchy(treeData, function (d) { return d.children; });
        root.x0 = 0;
        root.y0 = 0; // Top center

        update(root);

        function update(source) {
            const treeData = treemap(root);
            const nodes = treeData.descendants();
            const links = treeData.links();

            // Vertical Layout Adjustments
            // d.x is horizontal position
            // d.y is vertical depth (calculated by D3 based on hierarchy)
            nodes.forEach(d => { d.y = d.depth * 100; });

            // ****************** Nodes section ***************************
            const node = g.selectAll('g.node')
                .data(nodes, d => d.id || (d.id = ++i));

            const nodeEnter = node.enter().append('g')
                .attr('class', function (d) {
                    return "node " + (d.data.type || "other");
                })
                .attr("transform", d => "translate(" + source.x0 + "," + source.y0 + ")")
                .on('click', click);

            nodeEnter.append('circle')
                .attr('class', 'node')
                .attr('r', 1e-6)
                .style("fill", function (d) { return d._children ? "lightsteelblue" : "#fff"; });

            nodeEnter.append('text')
                .attr("dy", "0.35em")
                .attr("y", function (d) { return d.children || d._children ? -20 : 20; })
                .attr("text-anchor", "middle")
                .text(function (d) {
                    // truncate long names
                    return d.data.name.length > 20 ? d.data.name.substring(0, 18) + "..." : d.data.name;
                })
                .style("fill-opacity", 1e-6);

            const nodeUpdate = node.merge(nodeEnter).transition().duration(duration)
                .attr("transform", d => "translate(" + d.x + "," + d.y + ")");

            nodeUpdate.select('circle.node')
                .attr('r', 10)
                .style("fill", d => d._children ? "lightsteelblue" : "");

            nodeUpdate.select('text').style('fill-opacity', 1);

            const nodeExit = node.exit().transition().duration(duration)
                .attr("transform", d => "translate(" + source.x + "," + source.y + ")")
                .remove();

            nodeExit.select('circle').attr('r', 1e-6);
            nodeExit.select('text').style('fill-opacity', 1e-6);

            // ****************** Links section ***************************
            const link = g.selectAll('path.link')
                .data(links, d => d.target.id);

            const linkEnter = link.enter().insert('path', "g")
                .attr("class", "link")
                .attr('d', function (d) {
                    const o = { x: source.x0, y: source.y0 };
                    return diagonal(o, o);
                });

            const linkUpdate = link.merge(linkEnter).transition().duration(duration)
                .attr('d', d => diagonal(d.source, d.target));

            const linkExit = link.exit().transition().duration(duration)
                .attr('d', function (d) {
                    const o = { x: source.x, y: source.y };
                    return diagonal(o, o);
                })
                .remove();

            nodes.forEach(d => {
                d.x0 = d.x;
                d.y0 = d.y;
            });

            function diagonal(s, d) {
                // Vertical Bezier
                return `M ${s.x} ${s.y}
                    C ${s.x} ${(s.y + d.y) / 2},
                      ${d.x} ${(s.y + d.y) / 2},
                      ${d.x} ${d.y}`;
            }
        }

        // Interaction Logic
        let selectedNodeId = null;

        function click(event, d) {
            // Toggle Panel
            const panel = document.getElementById('details-panel');

            // Highlight logic
            d3.selectAll('.node').classed('selected', false);

            if (selectedNodeId === d.id) {
                // Deselect if clicking same node
                closePanel();
                selectedNodeId = null;
            } else {
                // Select new node
                d3.select(this).classed('selected', true);
                selectedNodeId = d.id;
                showDetails(d);
            }
        }

        function showDetails(d) {
            const panel = document.getElementById('details-panel');
            const title = document.getElementById('panel-title');
            const content = document.getElementById('panel-content');

            panel.classList.add('visible');
            title.innerText = d.data.name;

            let desc = d.data.description || "";

            let html = "";

            if (desc) {
                html += "<div class='details-section'>";
                html += "<div class='details-label'>Arguments & Details</div>";
                html += "<div class='details-content'>" + desc + "</div>";
                html += "</div>";
            }

            if (d.data.output && d.data.output.length > 0) {
                html += "<div class='details-section'>";
                html += "<div class='details-label'>Output Columns</div>";
                html += "<div class='details-content'>" + d.data.output.join("\n") + "</div>";
                html += "</div>";
            }

            if (d.data.metrics && Object.keys(d.data.metrics).length > 0) {
                html += "<div class='details-section'>";
                html += "<div class='details-label'>Runtime Metrics</div>";
                html += "<div class='details-content'>" + JSON.stringify(d.data.metrics, null, 2) + "</div>";
                html += "</div>";
            }

            content.innerHTML = html;
        }

        window.closePanel = function () {
            document.getElementById('details-panel').classList.remove('visible');
            d3.selectAll('.node').classed('selected', false);
            selectedNodeId = null;
        }

        // Zoom Controls
        const zoomBehavior = d3.zoom().on("zoom", (e) => g.attr("transform", e.transform));
        const svgSelect = d3.select("svg");

        function zoomIn() { svgSelect.transition().call(zoomBehavior.scaleBy, 1.2); }
        function zoomOut() { svgSelect.transition().call(zoomBehavior.scaleBy, 0.8); }
        function resetZoom() {
            svgSelect.transition().call(zoomBehavior.transform, d3.zoomIdentity.translate(width / 2, 50));
        }

        // Resize handler
        window.addEventListener('resize', () => {
            width = container.clientWidth;
            height = container.clientHeight;
            svgSelect.attr("width", width).attr("height", height);
        });

    </script>
</body>

</html>
